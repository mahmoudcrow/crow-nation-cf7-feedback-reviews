<?php

if (!defined('ABSPATH'))
    exit;

class CF7FR_Admin_Page
{

    public static function init()
    {
        add_action('admin_menu', [__CLASS__, 'register_page']);
    }

    public static function register_page()
    {
        add_menu_page(
            'Feedback Reviews',
            'Reviews',
            'manage_options',
            'cf7fr-reviews',
            [__CLASS__, 'render_page'],
            'dashicons-star-filled',
            25
        );
    }

    public static function render_reviews(): void
    {
        global $wpdb;

        $table = $wpdb->prefix . 'cf7fr_messages';
        $reviews = $wpdb->get_results("SELECT * FROM $table ORDER BY created_at DESC");

        echo '<div class="cf7fr-grid">';

        foreach ($reviews as $review) {
            $fields = json_decode($review->fields_json, true);

            $name = $fields['your-name'] ?? 'Anonymous';
            $rating = intval($fields['rating'] ?? 0);
            $testimonial = $fields['testimonial'] ?? '';
            $email = $fields['your-email'] ?? '';
            $phone = $fields['phone-number'] ?? '';
            $service = $fields['service-type'] ?? '';

            echo "<div class='cf7fr-card' id='cf7fr-card-{$review->id}'>
            <div class='cf7fr-header'>
                <h2>$name</h2>
                <p class='stars'>" . str_repeat('â˜…', $rating) . "</p>
            </div>

            <table class='cf7fr-fields'>
                <tr><th>Email</th><td>$email</td></tr>
                <tr><th>Phone</th><td>$phone</td></tr>
                <tr><th>Service</th><td>$service</td></tr>";

            foreach ($fields as $key => $value) {
                if (in_array($key, ['your-name', 'rating', 'testimonial', 'your-email', 'phone-number', 'service-type']))
                    continue;
                echo "<tr><th>" . esc_html($key) . "</th><td>" . esc_html($value) . "</td></tr>";
            }

            echo "</table>
            <p class='feedback'>" . esc_html($testimonial) . "</p>
            <div class='cf7fr-meta'>
                <span>IP: {$review->remote_ip}</span> |
                <span>URL: {$review->url}</span> |
                <span>Date: {$review->created_at}</span> |
                <span>UUID: {$review->uuid}</span>
            </div>
            <button class='download-btn' data-id='{$review->id}'>Download PNG</button>
        </div>";
        }

        echo '</div>';
    }
}